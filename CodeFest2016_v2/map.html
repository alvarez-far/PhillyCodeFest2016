<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>PhillyDistrictMap</title>
    <!-- [NOTES] -->


    <!-- [Principe Stuff] -->
    <!-- STYLESHEETS & BOOTSTRAP LIBRARIES -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- [PRODUCTION STYLESHEET] -->
    <!--<link rel="stylesheet" type="text/css" href="phillystyle.css">-->

    <!-- EXTERNAL LIBRARIES -->
    <!-- MapBox JS -->
    <script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.css' rel='stylesheet' />

    <!-- jQuery -->
    <script src="js/jquery-1.12.0.js"></script>

    <!-- [TEST CSS] -->
    <link rel="stylesheet" type="text/css" href="ignore.css" />

    <!-- [LOCAL JS Functions] -->
    <script>

        //LOAD Councilmen
        var councildata_src = "data/council.json";
        var councildata;

        $.getJSON(councildata_src, function (data) {
            councildata = data;
        });


        //------[MapBox®]------
        //Carlos Alvarez MapBox API KEY
        L.mapbox.accessToken = 'pk.eyJ1Ijoia3lsaW1hbmhhcm8iLCJhIjoic1VtaVk1VSJ9.XhSycFXpnjkaUGikAsdJxw';
        //39° 57′ 0″ N, 75° 10′ 0″ W
        var coordinates = [39.95, -75.166667];

        var currentRegion;
        //LOAD MapBox Map
        function loadMap() {
            
            var map = L.mapbox.map('map', 'mapbox.streets')
                .setView(coordinates, 12);

            //CREATE geocoder/search control
            var geocoderControl = L.mapbox.geocoderControl('mapbox.places',{ autocomplete: true, });
            geocoderControl.addTo(map);
            var resultLayer = L.mapbox.featureLayer();
            resultLayer.addTo(map);
            geocoderControl.on('select', function (res) {
                resultLayer.setGeoJSON(res.feature);
            });

            //REGION LAYER
            //WARNING! currentRegion name may be misleading
            currentRegion = L.mapbox.featureLayer().addTo(map);
            

            //LOAD geoJSON
            //var currentLayer = "geo/US_Congressional_2012.geojson";
            var currentLayer = "geo/Council_Districts_2016.geojson";
            $.getJSON(currentLayer, function (data) {
                //LOAD GEOJSON TO LAYER
                currentRegion.setGeoJSON(data);
                //map.featureLayer.setGeoJSON(data);
                pdm_addFeatureEvents();
            });

            function pdm_addFeatureEvents() {
                //Stuff for each region/feature of the layer
                currentRegion.eachLayer(function (focusRegion) {
                    var prop = focusRegion.feature.properties;
                    var district = prop.DISTRICT;
                    var districtData = councildata.district[district-1];
                    //popup markup
                    var popup = "<h1> Distirct " + district + "</h1>";
                    popup += "<div style=\"innerdiv\" >";
                    popup += "<p><strong>" + districtData.councilman + " (" + districtData.affiliation + ")</strong></p>";
                    popup += "<p>" + districtData.location + "</p>";
                    popup += "<p>" + districtData.phone + "</p>";
                    popup += "</div>";

                    //EVENTS
                    focusRegion.on('click', function () {
                        //[DEBUG]
                        //alert("District " + district);
                        focusRegion.openPopup();
                    });

                    focusRegion.bindPopup(popup);
                });
            }
        }

    </script>

</head>


<body>
    <div id="nav">
        <div class="innerdiv">
            <h1>PhillyDistrictMap</h1>
            <hr />
            <ul>
                <li class="selected">City Districs</li>
                <li>US Congressional Ditricts</li>
            </ul>
        </div>
    </div>
    <!-- [MAP] -->
    <div id="main">
        <div id='map'></div>
    </div>
    <script>
        //[DEBUG]: Single point of failure (Disable Map HERE)
        loadMap();
    </script>
    <!-- [END of MAP] -->
</body>
</html>
